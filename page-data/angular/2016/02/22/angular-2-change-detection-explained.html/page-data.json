{"componentChunkName":"component---src-templates-blog-post-js","path":"/angular/2016/02/22/angular-2-change-detection-explained.html","webpackCompilationHash":"0c5d630095500f933ccd","result":{"data":{"site":{"siteMetadata":{"title":"Articles by thoughtram","authors":[{"id":"pascal_precht","name":"Pascal Precht","twitter":"PascalPrecht","img":"https://avatars2.githubusercontent.com/u/445106?s=460&v=4"},{"id":"christoph_burgdorf","name":"Christoph Burgdorf","twitter":"cburgdorf","img":"https://avatars0.githubusercontent.com/u/521109?s=460&v=4"},{"id":"dominic_elm","name":"Dominic Elm","twitter":"d3lm","img":"https://avatars0.githubusercontent.com/u/12571019?s=400&v=4"},{"id":"thomas_burleson","name":"Thomas Burleson","twitter":"thomasburleson","img":"https://avatars3.githubusercontent.com/u/210413?s=400&v=4"},{"id":"elvira_eulitz","name":"Elvira Eulitz","twitter":"ElviraEulitz","img":"https://avatars3.githubusercontent.com/u/29247040?s=400&v=4"},{"id":"maxim_koretskyi","name":"Maxim Koretskyi","twitter":"maxim_koretskyi","img":"https://avatars3.githubusercontent.com/u/6124091?s=400&v=4"}]}},"markdownRemark":{"id":"0ebf4a36-3ec0-54ea-a09a-369dff2d19e0","excerpt":"NG-NL has happened and it was awesome! I had the honour of giving a talk about change detection in Angular and it seemed to be a huge success as attendees liked…","html":"<p><a href=\"http://ng-nl.org\">NG-NL</a> has happened and it was awesome! I had the honour of giving a talk about change detection in Angular and it seemed to be a huge success as attendees liked it a lot. With this article, we’d like to transform the talk into a written version, so everyone can read about how Angular’s change detection works and how to make it faster for our use cases. If you’re interested in the talk, you can view the <a href=\"http://pascalprecht.github.io/slides/angular-2-change-detection-explained/#/\">slides here</a> and <s>as soon as the talk recording is up, you’ll find it here as well</s> <a href=\"https://www.youtube.com/watch?v=CUxD91DWkGM\">watch the recording</a> on Youtube.</p>\n<p>Now let’s take a look at this beast.</p>\n<h2>What’s Change Detection anyways?</h2>\n<p>The basic task of change detection is to take the internal state of a program and make it somehow visible to the user interface. This state can be any kind of objects, arrays, primitives, … just any kind of JavaScript data structures.</p>\n<p>This state might end up as paragraphs, forms, links or buttons in the user interface and specifically on the web, it’s the Document Object Model (DOM). So basically we take data structures as input and generate DOM output to display it to the user. We call this process rendering.</p>\n<p><img src=\"/cec743a8e1904a4f0268047a87341368/cd-4.svg\"></p>\n<p>However, it gets trickier when a change happens at runtime. Some time later when the DOM has already been rendered. How do we figure out what has changed in our model, and where do we need to update the DOM? Accessing the DOM tree is always expensive, so not only do we need to find out where updates are needed, but we also want to keep that access as tiny as possible.</p>\n<p>This can be tackled in many different ways. One way, for instance, is simply making a http request and re-rendering the whole page. Another approach is the concept of diffing the DOM of the new state with the previous state and only render the difference, which is what ReactJS is doing with <strong>Virtual DOM</strong>.</p>\n<p><a href=\"http://twitter.com/teropa\">Tero</a> has written an awesome article on <a href=\"http://teropa.info/blog/2015/03/02/change-and-its-detection-in-javascript-frameworks.html\">Change and its detection in JavaScript frameworks</a>, we recommend checking it out if you’re more interested in how different frameworks solve this issue. In this article we’re going to focus on Angular version >= 2.x.</p>\n<p>So basically the goal of change detection is always projecting data and its change.</p>\n<h2>What causes change?</h2>\n<p>Now that we know what change detection is all about, we might wonder, when exactly can such a change happen? When does Angular know that it has to update the view? Well, let’s take a look at the following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  template<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    &lt;h1>{{firstname}} {{lastname}}&lt;/h1>\n    &lt;button (click)=\"changeName()\">Change name&lt;/button>\n  </span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyApp</span> <span class=\"token punctuation\">{</span>\n\n  firstname<span class=\"token punctuation\">:</span>string <span class=\"token operator\">=</span> <span class=\"token string\">'Pascal'</span><span class=\"token punctuation\">;</span>\n  lastname<span class=\"token punctuation\">:</span>string <span class=\"token operator\">=</span> <span class=\"token string\">'Precht'</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">changeName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>firstname <span class=\"token operator\">=</span> <span class=\"token string\">'Brad'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lastname <span class=\"token operator\">=</span> <span class=\"token string\">'Green'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If this is the first time you’re seeing an Angular component, you might want to read our article on <a href=\"/angular/2015/04/09/developing-a-tabs-component-in-angular-2.html\">building a tabs component</a>.</p>\n<p>The component above simply displays two properties and provides a method to change them when the button in the template is clicked. The moment this particular button is clicked is the moment when application state has changed, because it changes the properties of the component. That’s the moment we want to update the view.</p>\n<p>Here’s another one:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ContactsApp</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OnInit</span><span class=\"token punctuation\">{</span>\n\n  contacts<span class=\"token punctuation\">:</span>Contact<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> http<span class=\"token punctuation\">:</span> Http</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">ngOnInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/contacts'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">contacts</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>contacts <span class=\"token operator\">=</span> contacts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This component holds a list of contacts and when it initializes, it performs a http request. Once this request comes back, the list gets updated. Again, at this point, our application state has changed so we will want to update the view.</p>\n<p>Basically application state change can be caused by three things:</p>\n<ul>\n<li><strong>Events</strong> - <code class=\"language-text\">click</code>, <code class=\"language-text\">submit</code>, …</li>\n<li><strong>XHR</strong> - Fetching data from a remote server</li>\n<li><strong>Timers</strong> - <code class=\"language-text\">setTimeout()</code>, <code class=\"language-text\">setInterval()</code></li>\n</ul>\n<p>They are all asynchronous. Which brings us to the conclusion that, basically whenever some asynchronous operation has been performed, our application state might have changed. This is when someone needs to tell Angular to update the view.</p>\n<h2>Who notifies Angular?</h2>\n<p>Alright, we now know what causes application state change. But what is it that tells Angular, that at this particular moment, the view has to be updated?</p>\n<p>Angular allows us to use native APIs directly. There are no interceptor methods we have to call so Angular gets notified to update the DOM. Is that pure magic?</p>\n<p>If you’ve followed our latest articles, you know that <a href=\"/angular/2016/01/22/understanding-zones.html\">Zones</a> take care of this. In fact, Angular comes with its own zone called <code class=\"language-text\">NgZone</code>, which we’ve written about in our article <a href=\"/angular/2016/02/01/zones-in-angular-2.html\">Zones in Angular</a>. You might want to read that, too.</p>\n<p>The short version is, that somewhere in Angular’s source code, there’s this thing called <code class=\"language-text\">ApplicationRef</code>, which listens to <code class=\"language-text\">NgZones</code> <code class=\"language-text\">onTurnDone</code> event. Whenever this event is fired, it executes a <code class=\"language-text\">tick()</code> function which essentially performs change detection.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// very simplified version of actual source</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationRef</span> <span class=\"token punctuation\">{</span>\n\n  changeDetectorRefs<span class=\"token punctuation\">:</span>ChangeDetectorRef<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> zone<span class=\"token punctuation\">:</span> NgZone</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>zone<span class=\"token punctuation\">.</span>onTurnDone\n      <span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>zone<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>changeDetectorRefs\n      <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ref</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> ref<span class=\"token punctuation\">.</span><span class=\"token function\">detectChanges</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Change Detection</h2>\n<p>Okay cool, we now know when change detection is triggered, but how is it performed? Well, the first thing we need to notice is that, in Angular, <strong>each component has its own change detector</strong>.</p>\n<p><img src=\"/d7da04ce5f28d8d8ef7000fa4ed625d9/cd-tree-2.svg\"></p>\n<p>This is a significant fact, since this allows us to control, for each component individually, how and when change detection is performed! More on that later.</p>\n<p>Let’s assume that somewhere in our component tree an event is fired, maybe a button has been clicked. What happens next? We just learned that zones execute the given handler and notify Angular when the turn is done, which eventually causes Angular to perform change detection.</p>\n<p><img src=\"/44820d092a70af998a5c33b718f3969d/cd-tree-7.svg\"></p>\n<p>Since each component has its own change detector, and an Angular application consists of a component tree, the logical result is that we’re having a <strong>change detector tree</strong> too. This tree can also be viewed as a directed graph where data always flows from top to bottom.</p>\n<p>The reason why data flows from top to bottom, is because change detection is also always performed from top to bottom for every single component, every single time, starting from the root component. This is awesome, as unidirectional data flow is more predictable than cycles. We always know where the data we use in our views comes from, because it can only result from its component.</p>\n<p>Another interesting observation is that change detection gets stable after a single pass. Meaning that, if one of our components causes any additional side effects after the first run during change detection, Angular will throw an error.</p>\n<h2>Performance</h2>\n<p>By default, even if we have to check every single component every single time an event happens, Angular is very fast. It can perform hundreds of thousands of checks within a couple of milliseconds. This is mainly due to the fact that <strong>Angular generates VM friendly code</strong>.</p>\n<p>What does that mean? Well, when we said that each component has its own change detector, it’s not like there’s this single generic thing in Angular that takes care of change detection for each individual component.</p>\n<p>The reason for that is, that it has to be written in a dynamic way, so it can check every component no matter what its model structure looks like. VMs don’t like this sort of dynamic code, because they can’t optimize it. It’s considered <strong>polymorphic</strong> as the shape of the objects isn’t always the same.</p>\n<p><strong>Angular creates change detector classes at runtime</strong> for each component, which are monomorphic, because they know exactly what the shape of the component’s model is. VMs can perfectly optimize this code, which makes it very fast to execute. The good thing is that we don’t have to care about that too much, because Angular does it automatically.</p>\n<p>Check out <a href=\"http://twitter.com/victorsavkin\">Victor Savkin’s</a> talk on <a href=\"https://www.youtube.com/watch?v=jvKGQSFQf10\">Change Detection Reinvented</a> for a deeper explanation on this.</p>\n<h2>Smarter Change Detection</h2>\n<p>Again, Angular has to check every component every single time an event happens because… well, maybe the application state has changed. But wouldn’t it be great if we could tell Angular to <strong>only</strong> run change detection for the parts of the application that changed their state?</p>\n<p>Yes it would, and in fact we can! It turns out there are data structures that give us some guarantees of when something has changed or not - <strong>Immutables</strong> and <strong>Observables</strong>. If we happen to use these structures or types, and we tell Angular about it, change detection can be much much faster. Okay cool, but how so?</p>\n<p><strong>Understanding Mutability</strong></p>\n<p>In order to understand why and how e.g. immutable data structures can help, we need to understand what mutability means. Assume we have the following component:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  template<span class=\"token punctuation\">:</span> <span class=\"token string\">'&lt;v-card [vData]=\"vData\">&lt;/v-card>'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">VCardApp</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>vData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Christoph Burgdorf'</span><span class=\"token punctuation\">,</span>\n      email<span class=\"token punctuation\">:</span> <span class=\"token string\">'christoph@thoughtram.io'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">changeData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>vData<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'Pascal Precht'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">VCardApp</code> uses <code class=\"language-text\">&lt;v-card&gt;</code> as a child component, which has an input property <code class=\"language-text\">vData</code>. We’re passing data to that component with <code class=\"language-text\">VCardApp</code>’s own <code class=\"language-text\">vData</code> property. <code class=\"language-text\">vData</code> is an object with two properties. In addition, there’s a method <code class=\"language-text\">changeData()</code>, which changes the name of <code class=\"language-text\">vData</code>. No magic going on here.</p>\n<p>The important part is that <code class=\"language-text\">changeData()</code> mutates <code class=\"language-text\">vData</code> by changing its <code class=\"language-text\">name</code> property. Even though that property is going to be changed, the <code class=\"language-text\">vData</code> reference itself stays the same.</p>\n<p>What happens when change detection is performed, assuming that some event causes <code class=\"language-text\">changeData()</code> to be executed? First, <code class=\"language-text\">vData.name</code> gets changed, and then it’s passed to <code class=\"language-text\">&lt;v-card&gt;</code>. <code class=\"language-text\">&lt;v-card&gt;</code>’s change detector now checks if the given <code class=\"language-text\">vData</code> is still the same as before, and yes, it is. The reference hasn’t changed. However, the <code class=\"language-text\">name</code> property has changed, so Angular will perform change detection for that object nonetheless.</p>\n<p>Because objects are mutable by default in JavaScript (except for primitives), Angular has to be conservative and run change detection every single time for every component when an event happens.</p>\n<p>This is where immutable data structures come into play.</p>\n<h2>Immutable Objects</h2>\n<p>Immutable objects give us the guarantee that objects can’t change. Meaning that, if we use immutable objects and we want to make a change on such an object, we’ll always get a new reference with that change, as the original object is immutable.</p>\n<p>This pseudo code demonstrates it:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> vData <span class=\"token operator\">=</span> someAPIForImmutables<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Pascal Precht'</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> vData2 <span class=\"token operator\">=</span> vData<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Christoph Burgdorf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nvData <span class=\"token operator\">===</span> vData2 <span class=\"token comment\">// false</span></code></pre></div>\n<p><code class=\"language-text\">someAPIForImmutables</code> can be any API we want to use for immutable data structures. However, as we can see, we can’t simply change the <code class=\"language-text\">name</code> property. We’ll get a new object with that particular change and this object has a new reference.\nOr in short: <strong>If there’s a change, we get a new reference</strong>.</p>\n<h2>Reducing the number of checks</h2>\n<p>Angular can skip entire change detection subtrees when input properties don’t change. We just learned that a “change” means “new reference”. If we use immutable objects in our Angular app, all we need to do is tell Angular that a component can skip change detection, if its input hasn’t changed.</p>\n<p>Let’s see how that works by taking a look at <code class=\"language-text\">&lt;v-card&gt;</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  template<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    &lt;h2>{{vData.name}}&lt;/h2>\n    &lt;span>{{vData.email}}&lt;/span>\n  </span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">VCardCmp</span> <span class=\"token punctuation\">{</span>\n  @<span class=\"token function\">Input</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> vData<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As we can see, <code class=\"language-text\">VCardCmp</code> only depends on its input properties. Great. We can tell Angular to skip change detection for this component’s subtree if none of its inputs changed by setting the change detection strategy to <code class=\"language-text\">OnPush</code> like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  template<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    &lt;h2>{{vData.name}}&lt;/h2>\n    &lt;span>{{vData.email}}&lt;/span>\n  </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n  changeDetection<span class=\"token punctuation\">:</span> ChangeDetectionStrategy<span class=\"token punctuation\">.</span>OnPush\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">VCardCmp</span> <span class=\"token punctuation\">{</span>\n  @<span class=\"token function\">Input</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> vData<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That’s it! Now imagine a bigger component tree. We can skip entire subtrees when immutable objects are used and Angular is informed accordingly.</p>\n<p><img src=\"/bac05e8fc17328a1f27f61b62254db8c/cd-tree-8.svg\"></p>\n<p><a href=\"http://twitter.com/jvandemo\">Jurgen Van De Moere</a> has written an <a href=\"http://www.jvandemo.com/how-i-optimized-minesweeper-using-angular-2-and-immutable-js-to-make-it-insanely-fast/\">in-depth article</a> on how he made a minesweeper game built with Angular and Immutable.js blazingly fast. Make sure to check that one out.</p>\n<h2>Observables</h2>\n<p>As mentioned earlier, Observables also give us some certain guarantees of when a change has happened. Unlike immutable objects, they don’t give us new references when a change is made. Instead, they fire events we can subscribe to in order to react to them.</p>\n<p>So, if we use Observables and we want to use <code class=\"language-text\">OnPush</code> to skip change detector subtrees, but the reference of these objects will never change, how do we deal with that? It turns out Angular has a <strong>very smart</strong> way to enable paths in the component tree to be checked for certain events, which is exactly what we need in that case.</p>\n<p>To understand what that means, let’s take a look at this component:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  template<span class=\"token punctuation\">:</span> <span class=\"token string\">'{{counter}}'</span><span class=\"token punctuation\">,</span>\n  changeDetection<span class=\"token punctuation\">:</span> ChangeDetectionStrategy<span class=\"token punctuation\">.</span>OnPush\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CartBadgeCmp</span> <span class=\"token punctuation\">{</span>\n\n  @<span class=\"token function\">Input</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> addItemStream<span class=\"token punctuation\">:</span>Observable<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">ngOnInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>addItemStream<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>counter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// application state changed</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let’s say we build an e-commerce application with a shopping cart. Whenever a user puts a product into the shopping cart, we want a little counter to show up in our UI, so the user can see the amount of products in the cart.</p>\n<p><code class=\"language-text\">CartBadgeCmp</code> does exactly that. It has a <code class=\"language-text\">counter</code> and an input property <code class=\"language-text\">addItemStream</code>, which is a stream of events that gets fired, whenever a product is added to the shopping cart.</p>\n<p>We won’t go into much detail on how observables work in this article. If you want to learn more about observables, make sure to read our article on <a href=\"http://blog.thoughtram.io/angular/2016/01/06/taking-advantage-of-observables-in-angular2.html\">taking advantage of Observables in Angular</a>.</p>\n<p>In addition, we set the change detection strategy to <code class=\"language-text\">OnPush</code>, so change detection isn’t performed all the time, only when the component’s input properties change.</p>\n<p>However, as mentioned earlier, the reference of <code class=\"language-text\">addItemStream</code> will never change, so change detection is never performed for this component’s subtree. This is a problem because the component subscribes to that stream in its <code class=\"language-text\">ngOnInit</code> life cycle hook and increments the counter. This is application state change and we want to have this reflected in our view right?</p>\n<p>Here’s what our change detector tree might look like (we’ve set <strong>all</strong> to <code class=\"language-text\">OnPush</code>). No change detection will be performed when an event happens:</p>\n<p><img src=\"/8393e4d5673c51a3779a96651966d72d/cd-tree-10.svg\"></p>\n<p>How can we inform Angular about this change? How can we tell Angular that change detection <strong>needs</strong> to be performed for this component, even though the entire tree is set to <code class=\"language-text\">OnPush</code>?</p>\n<p>No worries, Angular has us covered. As we’ve learned earlier, change detection is <strong>always</strong> performed from top to bottom. So what we need is a way to detect changes for the entire path of the tree to the component where the change happened. Angular can’t know which path it is, but we do.</p>\n<p>We can access a component’s <code class=\"language-text\">ChangeDetectorRef</code> via <a href=\"/angular/2015/05/18/dependency-injection-in-angular-2.html\">dependency injection</a>, which comes with an API called <code class=\"language-text\">markForCheck()</code>. This method does exactly what we need! It marks the path from our component until root to be checked for the next change detection run.</p>\n<p>Let’s inject it into our component:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> cd<span class=\"token punctuation\">:</span> ChangeDetectorRef</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then, tell Angular to mark the path from this component until root to be checked:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">ngOnInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>addItemStream<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>counter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// application state changed</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>cd<span class=\"token punctuation\">.</span><span class=\"token function\">markForCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// marks path</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Boom, that’s it! Here’s what it looks like after the observable event is fired but before change detection kicked in:</p>\n<p><img src=\"/fbff06a4dd044202d9f7ec4964db846f/cd-tree-12.svg\"></p>\n<p>Now, when change detection is performed, it’ll simply go from top to bottom.</p>\n<p><img src=\"../assets/image/cd-tree-13.svg\"></p>\n<p>How cool is that? Once the change detection run is over, it’ll restore the <code class=\"language-text\">OnPush</code> state for the entire tree.</p>\n<h2>There’s more…</h2>\n<p>In fact there are some more APIs which we haven’t covered in this article, but feel free to check out the slides and/or the recording of the talk.</p>\n<p>There are also some demos to play with in this <a href=\"https://github.com/thoughtram/angular2-change-detection-demos\">repository</a>, which you can run on your local machine.</p>\n<p>Hopefully this made it a little bit more clear how using immutable data structures or Observables can make our Angular application even faster.</p>\n<h2>Credits</h2>\n<p>I’d like to thank <a href=\"http://twitter.com/jvandemo\">Jurgen Van De Moere</a> for being a <strong>huge</strong> help and support when I was preparing this talk. He spent a lot of time with me discussing my understandings and raised a lot of good questions that helped me put this content together. He also made sure that the demos look as nice as they do. His CSS skills are amazing - Jurgen, thank you so so much for being such a supportive and nice person.</p>\n<p>I’d also like to thank <a href=\"http://twitter.com/victorsavkin\">Victor Savkin</a> for answering a lot of my questions regarding change detection in Angular, plus all the very informative articles that he’s written - Thanks Victor!</p>","frontmatter":{"author":"pascal_precht","title":"Angular Change Detection Explained","imageUrl":{"childImageSharp":{"sizes":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAYBAgX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB0rqcoyC4H//EABkQAAIDAQAAAAAAAAAAAAAAAAACARESE//aAAgBAQABBQJSck0bY2x1c//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAMBAQAAAAAAAAAAAAAAAAABMRAy/9oACAEBAAY/AtpWdM//xAAbEAEAAgIDAAAAAAAAAAAAAAABACEQQTFxwf/aAAgBAQABPyFm0J0SzUW5cr9sJ//aAAwDAQACAAMAAAAQLP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAQADAAMAAAAAAAAAAAAAAQARMWEhceH/2gAIAQEAAT8QYCR1loZN5c3d9sFgEcRfSb//2Q==","aspectRatio":1.3333333333333333,"src":"/static/b95652f8a67cc82a9b4669fbc59a9a82/30037/change-detection-explained-bg.jpg","srcSet":"/static/b95652f8a67cc82a9b4669fbc59a9a82/10bdc/change-detection-explained-bg.jpg 158w,\n/static/b95652f8a67cc82a9b4669fbc59a9a82/f4ab0/change-detection-explained-bg.jpg 315w,\n/static/b95652f8a67cc82a9b4669fbc59a9a82/30037/change-detection-explained-bg.jpg 630w,\n/static/b95652f8a67cc82a9b4669fbc59a9a82/9810d/change-detection-explained-bg.jpg 945w,\n/static/b95652f8a67cc82a9b4669fbc59a9a82/90537/change-detection-explained-bg.jpg 1080w","sizes":"(max-width: 630px) 100vw, 630px"}}},"date":"22 February 2016","summary":"Wonder how change detection in Angular works?  This article is a write-up of that talk and discusses change detection and tricks to make is super fast.","categories":["angular"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/angular/2016/02/22/angular-2-change-detection-explained.html","previous":{"fields":{"slug":"/announcements/2016/02/10/sponsoring-angularconnect-again.html"},"frontmatter":{"date":"2016/02/10","title":"Sponsoring AngularConnect. Again.","categories":["announcements"]}},"next":{"fields":{"slug":"/angular/2016/03/14/custom-validators-in-angular-2.html"},"frontmatter":{"date":"2016/03/14","title":"Custom Validators in Angular","categories":["angular"]}}}}}