{"componentChunkName":"component---src-templates-blog-post-js","path":"/angular/2016/01/06/taking-advantage-of-observables-in-angular2.html","webpackCompilationHash":"0c5d630095500f933ccd","result":{"data":{"site":{"siteMetadata":{"title":"Articles by thoughtram","authors":[{"id":"pascal_precht","name":"Pascal Precht","twitter":"PascalPrecht","img":"https://avatars2.githubusercontent.com/u/445106?s=460&v=4"},{"id":"christoph_burgdorf","name":"Christoph Burgdorf","twitter":"cburgdorf","img":"https://avatars0.githubusercontent.com/u/521109?s=460&v=4"},{"id":"dominic_elm","name":"Dominic Elm","twitter":"d3lm","img":"https://avatars0.githubusercontent.com/u/12571019?s=400&v=4"},{"id":"thomas_burleson","name":"Thomas Burleson","twitter":"thomasburleson","img":"https://avatars3.githubusercontent.com/u/210413?s=400&v=4"},{"id":"elvira_eulitz","name":"Elvira Eulitz","twitter":"ElviraEulitz","img":"https://avatars3.githubusercontent.com/u/29247040?s=400&v=4"},{"id":"maxim_koretskyi","name":"Maxim Koretskyi","twitter":"maxim_koretskyi","img":"https://avatars3.githubusercontent.com/u/6124091?s=400&v=4"}]}},"markdownRemark":{"id":"da89f2c8-3de0-5bec-99b3-b91e3b8db04a","excerpt":"Some people seem to be confused why Angular seems to favor the Observable abstraction over the Promise abstraction when it comes to dealing with async behavior…","html":"<p>Some people seem to be confused why Angular seems to favor the Observable abstraction over the Promise abstraction when it comes to dealing with async behavior.</p>\n<p>There are pretty good resources about the difference between Observables and Promises already out there. I especially like to highlight this free <a href=\"https://egghead.io/lessons/rxjs-rxjs-observables-vs-promises\">7 minutes video</a> by <a href=\"https://twitter.com/benlesh\">Ben Lesh</a> on egghead.io. Technically there are a couple of obvious differences like the <em>disposability</em> and <em>lazyness</em> of Observables. In this article we like to focus on some practical advantages that Observables introduce for server communication.</p>\n<h2>The scenario</h2>\n<p>Consider you are building a search input mask that should instantly show you results as you type.</p>\n<p>If you’ve ever build such a thing before you are probably aware of the challenges that come with that task.</p>\n<p><strong>1. Don’t hit the search endpoint on every key stroke</strong></p>\n<p>Treat the search endpoint as if you pay for it on a per-request basis. No matter if it’s your own hardware or not. We shouldn’t be hammering\nthe search endpoint more often than needed. Basically we only want to hit it once the user has <em>stopped typing</em> instead of with every keystroke.</p>\n<p><strong>2. Don’t hit the search endpoint with the same query params for subsequent requests</strong></p>\n<p>Consider you type <em>foo</em>, stop, type another <em>o</em>, followed by an immediate backspace and rest back at <em>foo</em>. That should be just one request with the term <em>foo</em> and not two even if we technically stopped twice after we had <em>foo</em>  in the search box.</p>\n<p><strong>3. Deal with out-of-order responses</strong></p>\n<p>When we have multiple requests in-flight at the same time we must account for cases where they come back in unexpected order. Consider we first typed\n<em>computer</em>, stop, a request goes out, we type <em>car</em>, stop, a request goes out. Now we have two requests in-flight. Unfortunately the request that carries the results for <em>computer</em> comes back\nafter the request that carries the results for <em>car</em>. This may happen because they are served by different servers. If we don’t deal with such cases properly we may end up showing results for <em>computer</em> whereas the search box reads <em>car</em>.</p>\n<h2>Challenge accepted</h2>\n<p>We will use the free and open wikipedia API to write a little demo.</p>\n<p>For simplicity our demo will simply consist of two files: <code class=\"language-text\">app.ts</code> and <code class=\"language-text\">wikipedia-service.ts</code>. In a real world scenario we would most likely split things further up though.</p>\n<p>Let’s start with a Promise-based implementation that doesn’t handle any of the described edge cases.</p>\n<p>This is what our <code class=\"language-text\">WikipediaService</code> looks like. Despite the fact that the Http/JsonP API still has some little unergonomic parts, there shouldn’t be much of surprise here.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Injectable <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@angular/core'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> URLSearchParams<span class=\"token punctuation\">,</span> Jsonp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@angular/http'</span><span class=\"token punctuation\">;</span>\n\n@<span class=\"token function\">Injectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WikipediaService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> jsonp<span class=\"token punctuation\">:</span> Jsonp</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">search</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">term<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> search <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    search<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'action'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'opensearch'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    search<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'search'</span><span class=\"token punctuation\">,</span> term<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    search<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'format'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>jsonp\n                <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://en.wikipedia.org/w/api.php?callback=JSONP_CALLBACK'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> search <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">toPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Basically we are injecting the <code class=\"language-text\">Jsonp</code> service to make a <code class=\"language-text\">GET</code> request against the wikipedia API with a given search term. Notice that we call <code class=\"language-text\">toPromise</code> in order to get from an <code class=\"language-text\">Observable&lt;Response&gt;</code> to a <code class=\"language-text\">Promise&lt;Response&gt;</code>. With a little bit of <code class=\"language-text\">then</code>-chaining we eventually end up with a <code class=\"language-text\">Promise&lt;Array&lt;string&gt;&gt;</code> as the return type of our <code class=\"language-text\">search</code> method.</p>\n<p>So far so good, let’s take a look at the <code class=\"language-text\">app.ts</code> file that holds our <code class=\"language-text\">App</code> Component.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// check the plnkr for the full list of imports</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'...'</span><span class=\"token punctuation\">;</span>\n\n@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  selector<span class=\"token punctuation\">:</span> <span class=\"token string\">'my-app'</span><span class=\"token punctuation\">,</span>\n  template<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    &lt;div>\n      &lt;h2>Wikipedia Search&lt;/h2>\n      &lt;input #term type=\"text\" (keyup)=\"search(term.value)\">\n      &lt;ul>\n        &lt;li *ngFor=\"let item of items\">{{item}}&lt;/li>\n      &lt;/ul>\n    &lt;/div>\n  </span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AppComponent</span> <span class=\"token punctuation\">{</span>\n  items<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> wikipediaService<span class=\"token punctuation\">:</span> WikipediaService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">term</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wikipediaService<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>term<span class=\"token punctuation\">)</span>\n                         <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">items</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Not much of a surprise here either. We inject our <code class=\"language-text\">WikipediaService</code> and expose it’s functionality via a <code class=\"language-text\">search</code> method to the template. The template simply binds to <code class=\"language-text\">keyup</code> and calls <code class=\"language-text\">search(term.value)</code> leveraging Angular’s awesome <em>template ref</em> feature.</p>\n<p>We unwrap the result of the <code class=\"language-text\">Promise</code> that the <code class=\"language-text\">search</code> method of the <code class=\"language-text\">WikipediaService</code> returns and expose it as a simple Array of strings to the template so that we can have <code class=\"language-text\">*ngFor</code> loop through it and build up a list for us.</p>\n<p>Unfortunately this implementation doesn’t address any of the described edge cases that we would like to deal with. Let’s refactor our code to make it match the expected behavior.</p>\n<p><strong>Taming the user input</strong></p>\n<p>Let’s change our code to not hammer the endpoint with every keystroke but instead only send a request when the user stopped typing for 400 ms. This is where Observables really shine. The Reactive Extensions (Rx) offer a broad range of operators that let us alter the behavior of Observables and create new Observables with the desired semantics.</p>\n<p>To unveil such super powers we first need to get an <code class=\"language-text\">Observable&lt;string&gt;</code> that carries the search term that the user types in. Instead of manually binding to the <code class=\"language-text\">keyup</code> event, we can take advantage of Angular’s <code class=\"language-text\">formControl</code> directive. To use this directive, we first need to import the <code class=\"language-text\">ReactiveFormsModule</code> into our application module.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> NgModule <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@angular/core'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> BrowserModule <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@angular/platform-browser'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> JsonpModule <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@angular/http'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ReactiveFormsModule <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@angular/forms'</span><span class=\"token punctuation\">;</span>\n\n@<span class=\"token function\">NgModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  imports<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>BrowserModule<span class=\"token punctuation\">,</span> JsonpModule<span class=\"token punctuation\">,</span> ReactiveFormsModule<span class=\"token punctuation\">]</span>\n  declarations<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>AppComponent<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  bootstrap<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>AppComponent<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AppModule</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Once imported, we can use <code class=\"language-text\">formControl</code> from within our template and set it to the name <code class=\"language-text\">&quot;term&quot;</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">[formControl]</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>term<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>In our component we create an instance of <code class=\"language-text\">FormControl</code> from <code class=\"language-text\">@angular/form</code> and expose it as a field under the name <code class=\"language-text\">term</code> on our component.</p>\n<p>Behind the scenes <code class=\"language-text\">term</code> automatically exposes an <code class=\"language-text\">Observable&lt;string&gt;</code> as property <code class=\"language-text\">valueChanges</code> that we can subscribe to. Now that we have an <code class=\"language-text\">Observable&lt;string&gt;</code>, taming the user input is as easy as calling <code class=\"language-text\">debounceTime(400)</code> on our Observable. This will return a new <code class=\"language-text\">Observable&lt;string&gt;</code> that will only emit a new value when there haven’t been coming new values for 400ms.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">{</span>\n  items<span class=\"token punctuation\">:</span> Array<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  term <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormControl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> wikipediaService<span class=\"token punctuation\">:</span> WikipediaService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>term<span class=\"token punctuation\">.</span>valueChanges\n             <span class=\"token punctuation\">.</span><span class=\"token function\">debounceTime</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n             <span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">term</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wikipediaService<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>term<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">items</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Don’t hit me twice</strong></p>\n<p>As we said, it would be a waste of resources to send out another request for a search term that our app already shows the results for. Fortunately Rx simplifies many operations that it nearly feels unnecessary to mention them. All we have to do to achieve the desired behavior is to call the <code class=\"language-text\">distinctUntilChanged</code> operator right after we called <code class=\"language-text\">debounceTime(400)</code>. Again, we will get back an <code class=\"language-text\">Observable&lt;string&gt;</code> but one that ignores values that are the same as the previous.</p>\n<p><strong>Dealing with out-of-order responses</strong></p>\n<p>Dealing with out of order responses can be a tricky task. Basically we need a way to express that we aren’t interested anymore in results from previous in-flight requests as soon as we are sending out new requests. In other words: cancel out all previous request as soon as we start a new one. As I briefly mentioned in the beginning Observables are disposable which means we can unsubscribe from them.</p>\n<p>This is where we want to change our <code class=\"language-text\">WikipediaService</code> to return an <code class=\"language-text\">Observable&lt;Array&lt;string&gt;&gt;</code> instead of an <code class=\"language-text\">Promise&lt;Array&lt;string&gt;&gt;</code>. That’s as easy as dropping <code class=\"language-text\">toPromise</code> and using <code class=\"language-text\">map</code> instead of <code class=\"language-text\">then</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">search</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">term<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> search <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  search<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'action'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'opensearch'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  search<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'search'</span><span class=\"token punctuation\">,</span> term<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  search<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'format'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>jsonp\n              <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://en.wikipedia.org/w/api.php?callback=JSONP_CALLBACK'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> search <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now that our <code class=\"language-text\">WikipediaSerice</code> returns an Observable instead of a Promise we simply need to replace <code class=\"language-text\">then</code> with <code class=\"language-text\">subscribe</code> in our <code class=\"language-text\">App</code> component.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>term<span class=\"token punctuation\">.</span>valueChanges\n           <span class=\"token punctuation\">.</span><span class=\"token function\">debounceTime</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">distinctUntilChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">term</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wikipediaService<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>term<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">items</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>But now we have two <code class=\"language-text\">subscribe</code> calls. This is needlessly verbose and often a sign for unidiomatic usage.\nThe good news is, now that <code class=\"language-text\">search</code> returns an <code class=\"language-text\">Observable&lt;Array&lt;string&gt;&gt;</code> we can simply use <code class=\"language-text\">flatMap</code> to project our <code class=\"language-text\">Observable&lt;string&gt;</code> into the desired <code class=\"language-text\">Observable&lt;Array&lt;string&gt;&gt;</code> by composing the Observables.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>term<span class=\"token punctuation\">.</span>valueChanges\n         <span class=\"token punctuation\">.</span><span class=\"token function\">debounceTime</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n         <span class=\"token punctuation\">.</span><span class=\"token function\">distinctUntilChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n         <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">term</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wikipediaService<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>term<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n         <span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">items</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You may be wondering what <code class=\"language-text\">flatMap</code> does and why we can’t use <code class=\"language-text\">map</code> here. The answer is quite simple. The <code class=\"language-text\">map</code> operator expects a function that takes a value <code class=\"language-text\">T</code> and returns a value <code class=\"language-text\">U</code>. For instance a function that takes in a <code class=\"language-text\">string</code> and returns a <code class=\"language-text\">Number</code>. Hence when you use <code class=\"language-text\">map</code> you get from an <code class=\"language-text\">Observable&lt;T&gt;</code> to an <code class=\"language-text\">Observable&lt;U&gt;</code>. However, our <code class=\"language-text\">search</code> method produces an <code class=\"language-text\">Observable&lt;Array&gt;</code> itself. So coming from an <code class=\"language-text\">Observable&lt;string&gt;</code> that we have right after <code class=\"language-text\">distinctUntilChanged</code>, map would take us to an <code class=\"language-text\">Observable&lt;Observable&lt;Array&lt;string&gt;&gt;</code>. That’s not quite what we want.</p>\n<p>The <code class=\"language-text\">flatMap</code> operator on the other hand expects a function that takes a <code class=\"language-text\">T</code> and returns an <code class=\"language-text\">Observable&lt;U&gt;</code> and produces an <code class=\"language-text\">Observable&lt;U&gt;</code> for us.</p>\n<p><strong>NOTE</strong>: <em>That’s not entirely true, but it helps as a simplification</em>.</p>\n<p>That perfectly matches our case. We have an <code class=\"language-text\">Observable&lt;string&gt;</code>, then call <code class=\"language-text\">flatMap</code> with a function that takes a <code class=\"language-text\">string</code> and returns an <code class=\"language-text\">Observable&lt;Array&lt;string&gt;&gt;</code>.</p>\n<p>So does this solve our out-of-order response issues? Unfortunately not. So, why am I bothering you with all this in the first place? Well, now that you understood <code class=\"language-text\">flatMap</code> just replace it with <code class=\"language-text\">switchMap</code> and you are done.</p>\n<p>What?! You may be wondering if I’m kidding you but no I am not. That’s the beautify of Rx with all it’s useful operators. The <code class=\"language-text\">switchMap</code> operator is comparable to <code class=\"language-text\">flatMap</code> in a way. Both operators automatically subscribe to the Observable that the function produces and flatten the result for us. The difference is that the <code class=\"language-text\">switchMap</code> operator automatically unsubscribes from previous subscriptions as soon as the outer Observable emits new values.</p>\n<h2>Putting some sugar on top</h2>\n<p>Now that we got the semantics right, there’s one more little trick that we can use to save us some typing. Instead of manually subscribing to the Observable we can let Angular do the unwrapping for us right from within the template. All we have to do to accomplish that is to use the <code class=\"language-text\">AsyncPipe</code> in our template and expose the <code class=\"language-text\">Observable&lt;Array&lt;string&gt;&gt;</code> instead of <code class=\"language-text\">Array&lt;string&gt;</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">@<span class=\"token function\">Component</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  selector<span class=\"token punctuation\">:</span> <span class=\"token string\">'my-app'</span><span class=\"token punctuation\">,</span>\n  template<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    &lt;div>\n      &lt;h2>Wikipedia Search&lt;/h2>\n      &lt;input type=\"text\" [formControl]=\"term\"/>\n      &lt;ul>\n        &lt;li *ngFor=\"let item of items | async\">{{item}}&lt;/li>\n      &lt;/ul>\n    &lt;/div>\n  </span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">{</span>\n\n  items<span class=\"token punctuation\">:</span> Observable<span class=\"token operator\">&lt;</span>Array<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">>></span><span class=\"token punctuation\">;</span>\n  term <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormControl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">private</span> wikipediaService<span class=\"token punctuation\">:</span> WikipediaService</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>items <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>term<span class=\"token punctuation\">.</span>valueChanges\n                 <span class=\"token punctuation\">.</span><span class=\"token function\">debounceTime</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span>\n                 <span class=\"token punctuation\">.</span><span class=\"token function\">distinctUntilChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                 <span class=\"token punctuation\">.</span><span class=\"token function\">switchMap</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">term</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wikipediaService<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>term<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And voilà, we’re done. Check out the demos below!</p>","frontmatter":{"author":"christoph_burgdorf","title":"Taking advantage of Observables in Angular","imageUrl":{"childImageSharp":{"sizes":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAABaElEQVQ4y7VT206DQBDl/3/Cd+O7vjXReEmVVHuhRaVYKmlDK4VdlgW5HHe3oi2gTUycZMKes7OzZ3YGDb9YWZbKd/Eh0+rBVRKFP7+WZcFxnMb+Nmb/vFZP1KaGEAJK6Y9xuzm0+uE8z/cCJK4sy7LWuFaFYRhi47/hRu/DfJqCUAazd4l+5xgbwjCfTaGfHmG5cOH7Ac7OT3B3f43XuQvP874VVgmLokApnEYMafquuIQzxGSz3ReKomD9pTggPhiLFK641pKlpWmKJElUiTxJwTlXOBEXSU6u8yxvTESjKermIMBoNIJpmpiMxzAMQ+Ch6vRgMICu6+h2u7BfbFFVfrgpf7WGQsaYGA0Cw7QwdxeIxJhItbI5Vq8D1zZBxPtKjhKK2/4FHq0x1qu14hpNke/E4xjPtoOltxI4RhRRxDzFbHgFz7XVWnGM42EiynaeEQah4v6/5PovtedypGqcGrOyaDTlAyfk9NFur+7MAAAAAElFTkSuQmCC","aspectRatio":1.573643410852713,"src":"/static/2f9a1862455954f9ecd41b8ba550cbf4/57090/taking-advantage-of-observables.png","srcSet":"/static/2f9a1862455954f9ecd41b8ba550cbf4/d9446/taking-advantage-of-observables.png 158w,\n/static/2f9a1862455954f9ecd41b8ba550cbf4/2f6e7/taking-advantage-of-observables.png 315w,\n/static/2f9a1862455954f9ecd41b8ba550cbf4/57090/taking-advantage-of-observables.png 630w,\n/static/2f9a1862455954f9ecd41b8ba550cbf4/4ace0/taking-advantage-of-observables.png 945w,\n/static/2f9a1862455954f9ecd41b8ba550cbf4/db589/taking-advantage-of-observables.png 1015w","sizes":"(max-width: 630px) 100vw, 630px"}}},"date":"06 January 2016","summary":"Since version 2.x Angular favors Observables over Promises when it comes to async.  In this article we explore some practical advantages for server communication.","categories":["angular"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/angular/2016/01/06/taking-advantage-of-observables-in-angular2.html","previous":{"fields":{"slug":"/announcements/2015/12/31/angular2-master-class-at-ng-nl.html"},"frontmatter":{"date":"2015/12/31","title":"Angular 2 Jump Start at NG-NL 2016","categories":["announcements"]}},"next":{"fields":{"slug":"/angular/2016/01/07/taking-advantage-of-observables-in-angular2-pt2.html"},"frontmatter":{"date":"2016/01/07","title":"Taking advantage of Observables in Angular 2 - Part 2","categories":["angular"]}}}}}