{"componentChunkName":"component---src-templates-blog-post-js","path":"/rust/2015/05/11/rusts-ownership-model-for-javascript-developers.html","webpackCompilationHash":"0c5d630095500f933ccd","result":{"data":{"site":{"siteMetadata":{"title":"Articles by thoughtram","authors":[{"id":"pascal_precht","name":"Pascal Precht","twitter":"PascalPrecht","img":"https://avatars2.githubusercontent.com/u/445106?s=460&v=4"},{"id":"christoph_burgdorf","name":"Christoph Burgdorf","twitter":"cburgdorf","img":"https://avatars0.githubusercontent.com/u/521109?s=460&v=4"},{"id":"dominic_elm","name":"Dominic Elm","twitter":"d3lm","img":"https://avatars0.githubusercontent.com/u/12571019?s=400&v=4"},{"id":"thomas_burleson","name":"Thomas Burleson","twitter":"thomasburleson","img":"https://avatars3.githubusercontent.com/u/210413?s=400&v=4"},{"id":"elvira_eulitz","name":"Elvira Eulitz","twitter":"ElviraEulitz","img":"https://avatars3.githubusercontent.com/u/29247040?s=400&v=4"},{"id":"maxim_koretskyi","name":"Maxim Koretskyi","twitter":"maxim_koretskyi","img":"https://avatars3.githubusercontent.com/u/6124091?s=400&v=4"}]}},"markdownRemark":{"id":"6241d086-6874-5409-aef5-5298eb0b36f2","excerpt":"It’s been roughly one year ago since we organized Hannover’s first Rust meetup. Time has passed on and nickel has grown into a really nice web application…","html":"<p>It’s been roughly one year ago since we organized Hannover’s first <a href=\"http://blog.thoughtram.io/announcements/rust/meetups/2014/06/24/organizing-hannovers-first-rust-meetup.html\">Rust meetup</a>. Time has passed on and <a href=\"http://nickel.rs/\">nickel</a> has grown into a really nice web application framework with a very active community and 31 individual contributors as of the time of writing this.</p>\n<p>We also created <a href=\"https://github.com/thoughtram/clog\">clog</a> a changelog generator that started as a straight port of <a href=\"https://github.com/ajoslin/conventional-changelog\">conventional-changelog</a> but has since moved on to follow it’s own ideas and currently powers projects such as nickel and <a href=\"https://github.com/kbknapp/clap-rs\">clap</a>.</p>\n<p>I like to point out that both projects wouldn’t have been where they are today without the help of lots of helping hands from a bunch of smart people.</p>\n<p>While we wrote a lot about Angular and Git in this blog already, we didn’t actually took the time to explore Rust.</p>\n<p>Let’s change that and start with baby steps. Many readers of this blog are familiar with JavaScript so let’s explore a core concept of Rust from the perspective of a JavaScript developer.</p>\n<h2>Memory management</h2>\n<p>Most languages (JavaScript included) use a garbage collector to ensure memory safety.</p>\n<p>Well then, what’s the job of a garbage collector anyway? Basically it frees up memory that isn’t used anymore, that is, memory that nothing in the program points to anymore. Traditionally languages that are not memory safe such as C and C++ delegate that work to the developer. As we all know humans aren’t free from failure and so here are some examples of problems that may arise with manual memory management</p>\n<ul>\n<li>access to memory that has already been freed</li>\n<li>trying to free memory that has already been freed (double free)</li>\n<li>not freeing memory at all that rather should have been freed (memory leak)</li>\n</ul>\n<h2>The concept of ownership in Rust</h2>\n<p>Rust doesn’t use a garbage collector while still being 100 % memory safe. So how does that work and how does it affect the way we write our code?</p>\n<p>Let’s explore it by comparing some simple JavaScript code (written in ES6) with it’s Rust counterpart.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Product</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Config</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">debugMode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>debugMode <span class=\"token operator\">=</span> debugMode<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_config <span class=\"token operator\">=</span> config<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">getProduct</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_config<span class=\"token punctuation\">.</span>debugMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'retrieving product for id'</span> <span class=\"token operator\">+</span> id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Product</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BasketService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_config <span class=\"token operator\">=</span> config<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">addProduct</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">product</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_config<span class=\"token punctuation\">.</span>debugMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'adding product %O'</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Config</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> productService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ProductService</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> basketService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BasketService</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> product <span class=\"token operator\">=</span> productService<span class=\"token punctuation\">.</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbasketService<span class=\"token punctuation\">.</span><span class=\"token function\">addProduct</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>It’s a simple e-commerce example with four different classes working hand in hand. We have a <code class=\"language-text\">Product</code> class without any functionality because it’s sole purpose is to represent a product in this demo context. Then there’s a <code class=\"language-text\">Config</code> class which may contain a bunch of configurations such as API endpoints or simply a <code class=\"language-text\">debugMode</code> flag as in our simple example. And last but not least do we have a <code class=\"language-text\">ProductService</code> to retrieve products from and a <code class=\"language-text\">BasketService</code> to put products into a shopping basket.</p>\n<p>Let’s fokus on what follows after the definition of those classes.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Config</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> productService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ProductService</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> basketService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BasketService</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> product <span class=\"token operator\">=</span> productService<span class=\"token punctuation\">.</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbasketService<span class=\"token punctuation\">.</span><span class=\"token function\">addProduct</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We create an instance of a <code class=\"language-text\">Config</code> and pass it to both services. The last two lines show how the two services are used. Easy enough, right?</p>\n<p>Let’s write the same thing in Rust but instead of directly jumping to the final version let me take you on a journey to illustrate the process of how to get there.</p>\n<p>We leave out the <code class=\"language-text\">getProduct</code> and <code class=\"language-text\">addProduct</code> methods for our first implementation as they are just a distraction at this point.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Product<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> Config <span class=\"token punctuation\">{</span>\n    debug_mode<span class=\"token punctuation\">:</span> bool\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> ProductService <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> Config\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">struct</span> BasketService <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> Config\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> ProductService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> ProductService <span class=\"token punctuation\">{</span>\n        ProductService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> BasketService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> BasketService <span class=\"token punctuation\">{</span>\n        BasketService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> Config <span class=\"token punctuation\">{</span> debug_mode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The first thing to notice here is that Rust has no classes but instead has structs. It’s out of the scope of this article to discuss the differences though. The second thing to notice is that methods aren’t written in the struct definition but are attached to a struct through an <code class=\"language-text\">impl</code> block instead.</p>\n<p>Also does Rust not know any <code class=\"language-text\">constructor</code> concept. Instances of structs can simply be made by writing out the structs name followed by curly braces and a body that initializes all of the structs fields. However it’s a common pattern to add a “static” <code class=\"language-text\">new</code> method to the struct that wraps the initialization code. This <code class=\"language-text\">new</code> method is quite compareable to the <code class=\"language-text\">constructor</code> in our ES6 classes.</p>\n<p>To get things going we need to put the code that creates a config and both services in the <code class=\"language-text\">main</code> function.</p>\n<p>Ok, so we have our first version to try. That wasn’t all that hard, was it? But no, what’s that? When we try to run the code the compiler tells us that something isn’t quite right.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">src/main.rs:37:45: 37:51 error: use of moved value: `config`\nsrc/main.rs:37     let basket_service = BasketService::new(config);\n                                                           ^~~~~~\nsrc/main.rs:36:47: 36:53 note: `config` moved here because it has type `Config`, which is non-copyable\nsrc/main.rs:36     let product_service = ProductService::new(config);</code></pre></div>\n<p>The compiler disallows usage of <code class=\"language-text\">config</code> in line 37 because it moved in line 36. Uhm..what’s a move? Let’s go back to how this all started. We were talking about memory management and how Rust assures 100 % memory safety without the usage of a garbage collector.</p>\n<p>When we look back at the JavaScript version we can see that there are three places in our program that hold a reference to the <code class=\"language-text\">config</code>. Each service holds a reference as well as the calling code that creates <code class=\"language-text\">config</code> in the first place.</p>\n<p>Since JavaScript is garbage collected we don’t put much thought into that. A garbage collector will just regulary run checks and if it discovers that there is no reference anymore that points to the memory that was allocated for the <code class=\"language-text\">config</code>, it will free it up.</p>\n<p>Rust doesn’t have a garbage collector but it doesn’t force you to manage the memory manually either. Instead it creates new rules to enforce memory safety without garbage collection, namely “Ownership”.</p>\n<p>Being the owner of an object means that you (and only you) own the right to destroy it.</p>\n<p>Let’s see what that really means in the context of our program. The comments explain what happens line by line.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> Config <span class=\"token punctuation\">{</span> debug_mode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// at this point config is owned by the `main` function</span>\n    <span class=\"token comment\">// which also means the memory would be freed</span>\n    <span class=\"token comment\">// at the end of the main function</span>\n\n\n    <span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// at this point config is owned by the `new` method.</span>\n    <span class=\"token comment\">// So the main method is no longer the owner of `config`</span>\n    <span class=\"token comment\">// and further use of `config` is prohibited</span>\n\n    <span class=\"token comment\">// config can't be used here because `main` doesn't own</span>\n    <span class=\"token comment\">// it any more</span>\n    <span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You may be wondering why we can’t just continue to use <code class=\"language-text\">config</code> without being the owner. The point is that since the <code class=\"language-text\">new</code> method is now the new owner it may just decide to free up the memory. Keep in mind that the owner has the right to destroy the thing that it owns (either explicitly or implicity when it goes out of scope).</p>\n<p>If we were allowed to use <code class=\"language-text\">config</code> in the last line the memory may already be freed and hell breaks loose. The rust compiler prevents us from a potential runtime crash here.</p>\n<p><strong>The concept of borrowing</strong></p>\n<p>The good news is that we don’t <strong>have</strong> to transfer ownership each time we pass something to another method. We can just lend out a reference instead.</p>\n<p>Before we refactor our code to have the services borrow the config, we will temporarily simplify the code one last time to make it obvious why the move happens.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Product<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> Config <span class=\"token punctuation\">{</span>\n    debug_mode<span class=\"token punctuation\">:</span> bool\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> ProductService<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">struct</span> BasketService<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">impl</span> ProductService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> ProductService <span class=\"token punctuation\">{</span>\n        ProductService\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> BasketService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> BasketService <span class=\"token punctuation\">{</span>\n        BasketService\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> Config <span class=\"token punctuation\">{</span> debug_mode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We removed the config from both services so that the <code class=\"language-text\">new</code> methods still takes the <code class=\"language-text\">config</code> as parameter but doesn’t use it at all. We are still running into the same error.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">src/main.rs:27:45: 27:51 error: use of moved value: `config`\nsrc/main.rs:27     let basket_service = BasketService::new(config);\n                                                           ^~~~~~\nsrc/main.rs:26:47: 26:53 note: `config` moved here because it has type `Config`, which is non-copyable\nsrc/main.rs:26     let product_service = ProductService::new(config);</code></pre></div>\n<p>The reason for that lies in the method signature of <code class=\"language-text\">new</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> ProductService</code></pre></div>\n<p>This method signature says: “I’m a method that takes ownership of a <code class=\"language-text\">Config</code> and returns a <code class=\"language-text\">ProductService</code>“.</p>\n<p>But we can change it to borrow a reference instead.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Product<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> Config <span class=\"token punctuation\">{</span>\n    debug_mode<span class=\"token punctuation\">:</span> bool\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> ProductService<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">struct</span> BasketService<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">impl</span> ProductService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> ProductService <span class=\"token punctuation\">{</span>\n        ProductService\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> BasketService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> BasketService <span class=\"token punctuation\">{</span>\n        BasketService\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> Config <span class=\"token punctuation\">{</span> debug_mode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Whew, this compiles! The <code class=\"language-text\">&amp;Config</code> as the parameter type means that it now borrows a reference instead of taking ownership. The <code class=\"language-text\">main</code> method continues to be the owner with this change.</p>\n<p>But there’s another thing that we changed. Because the <code class=\"language-text\">new</code> methods now expect a reference instead of the actual type, we need to change the call site, too.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The leading <code class=\"language-text\">&amp;</code> before <code class=\"language-text\">config</code> means that we pass the memory address to the config instead of passing the actual data. And that brings us closer to our JavaScript version which also just passes a reference to <code class=\"language-text\">config</code> under the cover.</p>\n<p>Let’s change our code back to store the config in the services so that the service methods can have access to it.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Product<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> Config <span class=\"token punctuation\">{</span>\n    debug_mode<span class=\"token punctuation\">:</span> bool\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> ProductService <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">struct</span> BasketService <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> ProductService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> ProductService <span class=\"token punctuation\">{</span>\n        ProductService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> BasketService <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> BasketService <span class=\"token punctuation\">{</span>\n        BasketService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> Config <span class=\"token punctuation\">{</span> debug_mode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Unfortunately this gives us another error.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">src/main.rs:8:13: 8:20 error: missing lifetime specifier [E0106]\nsrc/main.rs:8     config: &amp;Config\n                          ^~~~~~~\nsrc/main.rs:11:13: 11:20 error: missing lifetime specifier [E0106]\nsrc/main.rs:11     config: &amp;Config</code></pre></div>\n<p>Rust’s memory management relies on a concept of lifetimes to track references. Most of the time you won’t even notice it because Rust lets us omit most lifetime annotations. But there are cases where Rust needs lifetime annotations such as when defining structs that hold references.</p>\n<p>Since we changed our services to store a reference to a <code class=\"language-text\">Config</code> instead of the <code class=\"language-text\">Config</code> itself rusts expect us to annotate our services with lifetime annotations.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Product<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> Config <span class=\"token punctuation\">{</span>\n    debug_mode<span class=\"token punctuation\">:</span> bool\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> ProductService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token lifetime-annotation symbol\">'a</span> Config\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">struct</span> BasketService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token lifetime-annotation symbol\">'a</span> Config\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span><span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> ProductService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> ProductService <span class=\"token punctuation\">{</span>\n        ProductService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span><span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> BasketService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> BasketService <span class=\"token punctuation\">{</span>\n        BasketService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> Config <span class=\"token punctuation\">{</span> debug_mode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Whew, that’s a lot of new syntax that we haven’t seen yet.</p>\n<p>Basically what the <code class=\"language-text\">&#39;a</code> lifetime annotation says is that the <code class=\"language-text\">ProductService</code> can’t live longer than the reference to the <code class=\"language-text\">Config</code> that it contains. Rust doesn’t infer that constrain for structs by itself so it needs us to bring clarity. The same helds true for the <code class=\"language-text\">BasketService</code> as it also keeps a reference to the <code class=\"language-text\">Config</code>.</p>\n<p>The <code class=\"language-text\">&#39;a</code> is really only a name that we get to choose, we could have picked <code class=\"language-text\">&#39;config</code> but short single letter names are mostly used among the Rust community.</p>\n<p>We need to use the life time annotation in the <code class=\"language-text\">impl</code> blocks as well as those are written for the <code class=\"language-text\">ProductService</code> and <code class=\"language-text\">BasketService</code> which introduce those lifetimes. Please note that the <code class=\"language-text\">&#39;a</code> of the <code class=\"language-text\">ProductService</code> is independend of the <code class=\"language-text\">&#39;a</code> of the <code class=\"language-text\">BasketService</code> we could have picked different names for both.</p>\n<p>A deep dive into the topic of lifetimes is out of scope for this article but we’ll make sure to cover them in more detail with follow up posts.</p>\n<p>Now that we got things working with the minimal code needed let’s jump to the final version which introduces the <code class=\"language-text\">get_product</code> and <code class=\"language-text\">add_product</code> methods to the services.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Config <span class=\"token punctuation\">{</span>\n    debug_mode<span class=\"token punctuation\">:</span> bool\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[derive(Debug)]</span>\n<span class=\"token keyword\">struct</span> Product<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> ProductService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token lifetime-annotation symbol\">'a</span> Config\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">struct</span> BasketService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token lifetime-annotation symbol\">'a</span> Config\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span><span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> ProductService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> ProductService <span class=\"token punctuation\">{</span>\n        ProductService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">get_product</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> i32<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> Product <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>debug_mode <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"retrieving product for id: {:?}\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        Product\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span><span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> BasketService<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> BasketService <span class=\"token punctuation\">{</span>\n        BasketService <span class=\"token punctuation\">{</span>\n            config<span class=\"token punctuation\">:</span> config\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">add_product</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">:</span> Product<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>debug_mode <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"adding product {:?}\"</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> Config <span class=\"token punctuation\">{</span> debug_mode<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> product_service <span class=\"token operator\">=</span> ProductService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> basket_service <span class=\"token operator\">=</span> BasketService<span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> product <span class=\"token operator\">=</span> product_service<span class=\"token punctuation\">.</span><span class=\"token function\">get_product</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    basket_service<span class=\"token punctuation\">.</span><span class=\"token function\">add_product</span><span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The rest of the code shouldn’t be too scary with the <code class=\"language-text\">#[derive(Debug)]</code> annotation being the only exception. For now let’s just accept that those are needed in order to print out the product with the <code class=\"language-text\">println!</code> macro.</p>\n<p>The code is a bit more verbose than the JavaScript version which mostly boils down to the fact that JavaScript isn’t strongly typed. I still find the Rust code quite expressive and terse if we consider the benefits of safety, memory usage and performance.</p>","frontmatter":{"author":"christoph_burgdorf","title":"Rust's Ownership model for JavaScript developers","imageUrl":null,"date":"11 May 2015","summary":"In this post we explore Rust's concept of ownership that enables the language to achieve 100 % memory safety without garbage collection.","categories":["rust"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/rust/2015/05/11/rusts-ownership-model-for-javascript-developers.html","previous":{"fields":{"slug":"/angular/2015/05/09/writing-angular-2-code-in-es5.html"},"frontmatter":{"date":"2015/05/09","title":"Writing Angular code in ES5","categories":["angular"]}},"next":{"fields":{"slug":"/announcements/2015/05/11/sponsoring-angularconnect.html"},"frontmatter":{"date":"2015/05/11","title":"Sponsoring AngularConnect","categories":["announcements"]}}}}}